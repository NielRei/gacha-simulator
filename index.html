<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="priestess_logo.png">
    <title>Gacha Simulator</title>
</head>
<body>

    <header>
        <img src="nymph.png" alt="Logo" />
        <div>
            <h2>
                Customizable Gacha Simulator
                <small class="header-subtext">(w/ Monte Carlo Simulation)</small>
                <small class="header-subtext">v0.0.1</small>
            </h2>
            <p>
                <i> After using, please answer the survey form for my thesis!
                <a href="https://forms.gle/xnt2UUgmYqDMzo7T8" target="_blank" rel="noopener">https://forms.gle/xnt2UUgmYqDMzo7T8</a> </i>
            </p>
        </div>
    </header>

    <main>
        <div id="settingsPanel">
            <h3>
                Banner Drop Rates
                <span id="validationMessage"></span>
            </h3>
        
            <div class="rate-sections">
                <!-- Base Rate Section -->
                <div class="rate-box">
                    <div>
                        <span>5★ Base Rate:</span>
                        <input type="text" id="fiveStarBaseRate" value="2.00" min="1" max="100"
                            oninput="validateDecimalInput('fiveStarBaseRate'); updateThreeStarRate();"
                            onblur="formatDecimalInput('fiveStarBaseRate')">
                        <span class="tight-percent">%</span>
                    </div>
        
                    <div>
                        <span>4★ Base Rate:</span>
                        <input type="text" id="fourStarBaseRate" value="8.00" min="1" max="100"
                            oninput="validateDecimalInput('fourStarBaseRate'); updateThreeStarRate();"
                            onblur="formatDecimalInput('fourStarBaseRate')">
                        <span class="tight-percent">%</span>
                    </div>
        
                    <div>
                        <span>3★ Base Rate:</span>
                        <input type="number" id="threeStarRate" value="90.00" disabled>
                        <span class="tight-percent">%</span>
                    </div>
                </div>
        
                <!-- RateUp Distribution Rate Section -->
                <div class="rate-box">
                    <div>
                        <span>5★ Rate-Up Distribution:</span>
                        <input type="text" id="fiveStarRateUpDistributionRate" value="50.00" min="0" max="100"
                            oninput="validateDecimalInput('fiveStarRateUpDistributionRate'); updateRateUpRates();"
                            onblur="formatDecimalInput('fiveStarRateUpDistributionRate')">
                        <span class="tight-percent">%</span>
                    </div>
        
                    <div>
                        <span>4★ Rate-Up Distribution:</span>
                        <input type="text" id="fourStarRateUpDistributionRate" value="50.00" min="0" max="100"
                            oninput="validateDecimalInput('fourStarRateUpDistributionRate'); updateRateUpRates();"
                            onblur="formatDecimalInput('fourStarRateUpDistributionRate')">
                        <span class="tight-percent">%</span>
                    </div>
                </div>
            </div>
            
            <h3>
                Banner Item Pool
                <span id="validationRateUpRateUpMessage"></span>
            </h3>
            
            <div class="rate-sections">
                <div class="rate-box">            
                    <div>
                        <span>5★ Rate-Up Items:</span>
                        <input type="number" id="fiveStarRateUpItems" value="1" min="1"
                               oninput="sanitizeIntegerInput(this)" onblur="validateIntegerInput(this, 10)">
                    </div>
            
                    <div>
                        <span>4★ Rate-Up Items:</span>
                        <input type="number" id="fourStarRateUpItems" value="3" min="1"
                               oninput="sanitizeIntegerInput(this)" onblur="validateIntegerInput(this, 10)">
                    </div>
                </div>
                <div class="rate-box">  
                    <div>
                        <span>5★ Non-Rate-Up Items:</span>
                        <input type="number" id="fiveStarNonRateUpItems" value="5" min="1" disabled>
                    </div>
            
                    <div>
                        <span>4★ Non-Rate-Up Items:</span>
                        <input type="number" id="fourStarNonRateUpItems" value="20" min="1" disabled>
                    </div>
                </div>
            </div>
            
            <h3>
                Banner Rules
            </h3>
            
            <!-- Enable Hard Pity System -->
            <div class="rate-sections">
                <!-- Hard Pity Rate Box -->
                <div class="rate-box">
                    <div>
                        <input type="checkbox" id="enableHardPity" onchange="toggleHardPitySettings()">
                        <label for="enableHardPity">Enable Hard Pity System</label>
                    </div>
            
                    <div id="hardPitySettings" style="display: none;">
                        <div class="subsettings">
                            <div>
                                <span>5★ Hard Pity Cap:</span>
                                <input type="number" id="fiveStarPity" value="90" min="1"
                                       oninput="sanitizeIntegerInput(this)" onblur="validateIntegerInput(this)">
                                <div class="guarantee-group" style="margin-top: 0.25rem;">
                                    <input type="checkbox" id="enableFiveStarGuaranteed" onchange="toggleGuaranteedInput('five')">
                                    <label for="enableFiveStarGuaranteed">Guarantee Rate-Up after</label>
                                    <input type="number" id="fiveStarGuaranteedAfter" value="1" min="1" style="display: none;"
                                           oninput="sanitizeIntegerInput(this)" onblur="validateIntegerInput(this)">
                                    <span id="fiveGuaranteedLabel" style="display: none;">Non-Rate-Up pulls</span>
                                </div>
                            </div>
            
                            <div style="margin-top: 0.5rem;">
                                <span>4★ Hard Pity Cap:</span>
                                <input type="number" id="fourStarPity" value="10" min="1"
                                       oninput="sanitizeIntegerInput(this)" onblur="validateIntegerInput(this)">
                                <div class="guarantee-group" style="margin-top: 0.25rem;">
                                    <input type="checkbox" id="enableFourStarGuaranteed" onchange="toggleGuaranteedInput('four')">
                                    <label for="enableFourStarGuaranteed">Guarantee Rate-Up after</label>
                                    <input type="number" id="fourStarGuaranteedAfter" value="1" min="1" style="display: none;"
                                           oninput="sanitizeIntegerInput(this)" onblur="validateIntegerInput(this)">
                                    <span id="fourGuaranteedLabel" style="display: none;">NonRate-Up pulls</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            
                <!-- Soft Pity Rate Box -->
                <div class="rate-box">          
                    <div>
                        <input type="checkbox" id="enableSoftPity" onchange="toggleSoftPitySettings()">
                        <label for="enableSoftPity">Enable Soft Pity System</label>
                    </div>
            
                    <div id="softPitySettings" style="display: none;">
                        <div class="subsettings">
                            <div>
                                <span>5★ Soft Pity Threshold:</span>
                                <input type="number" id="softPityFiveStarThreshold" value="51" min="1"
                                       style="width: 6ch; margin-left: 0.5rem;"
                                       oninput="sanitizeIntegerInput(this)" onblur="validateIntegerInput(this)">
                            </div>
            
                            <div style="margin-top: 0.5rem;">
                                <span>4★ Soft Pity Threshold:</span>
                                <input type="number" id="softPityFourStarThreshold" value="9" min="2"
                                       style="width: 6ch; margin-left: 0.5rem;"
                                       oninput="sanitizeIntegerInput(this)" onblur="validateIntegerInput(this)">
                            </div>
            
                            <div style="margin-top: 0.5rem;">
                                <span>5★ Soft Pity Increment:</span>
                                <input type="text" id="softPityFiveStarRate" value="2" min="0" step="0.1"
                                       oninput="validateDecimalInput('softPityFiveStarRate')"
                                       onblur="formatDecimalInput('softPityFiveStarRate')"
                                       style="width: 6ch; margin-left: 0.5rem;">
                                <span class="tight-percent">% per pull</span>
                            </div>
            
                            <div style="margin-top: 0.5rem;">
                                <span>4★ Soft Pity Increment:</span>
                                <input type="text" id="softPityFourStarRate" value="42" min="0" step="0.1"
                                       oninput="validateDecimalInput('softPityFourStarRate')"
                                       onblur="formatDecimalInput('softPityFourStarRate')"
                                       style="width: 6ch; margin-left: 0.5rem;">
                                <span class="tight-percent">% per pull</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="rate-box">
                    <div>
                        <input type="checkbox" id="enableSparking" onchange="toggleSparkingSettings()">
                        <label for="enableSparking">Enable Sparking System</label>
                    </div>
                
                    <div id="sparkingSettings" style="display: none;">
                        <div class="subsettings">
                            <div>
                                <span>5★ Pull Requirement:</span>
                                <input type="number" id="fiveStarSparkRequirement" value="300" min="1"
                                       oninput="sanitizeIntegerInput(this)" onblur="validateIntegerInput(this)">
                                <span class="tight-percent">pulls</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>            
            
        
            <h3>
                Banner Pull Cost
            </h3>

            <div>
                <span>Cost per Pull:</span>
                <input type="text" id="costPerPull" value="0.555" min="0" step="0.01" oninput="validateDecimalInput('costPerPull')">
                <span class="tight-percent">$</span>
            </div>
                
            <h3> 
                Monte Carlo Simulation
                <button id="RunSimulationBtn" onclick="runMonteCarloSimulation()">Run Simulation</button>
            </h3>
            
            <div>
                <label for="simulationCount">Pulls:</label>
                <input type="number" id="simulationCount" value="500000" min="1" step="1" oninput="sanitizeIntegerInput(this)" onblur="validateIntegerInput(this, 999999)"/>
            </div>
        
        </div>

        <div id="resultsPanel">
            <h3>Simulation Results</h3>
            <span>Click "Run Simulation" to get started.</span>
            
            <!-- Guide for Dummies Section -->
            <section style="margin-top: 1rem; font-size: 0.95rem; background-color: #1f2a44; padding: 1rem; border-radius: 0.5rem;">
                <h4 style="margin-bottom: 0.5rem; font-size: 1.1rem; color: #ffffff;">Guide for Dummies:</h4>
                <ul style="list-style-type: disc; margin-left: 1.25rem; color: #dfeaff;">
                    <li><strong>Base Rate:</strong> Chance to pull a 5★/4★ item</li>
                    <li><strong>Rate-Up Distribution:</strong> Chance to get a Rate-Up item upon pulling a 5★/4★ (50/50, 75/25 system)</li>
                    <br>
                    <li><strong>Rate-Up Items:</strong> Specific "Featured" Items on a banner, typically with a higher rate-up</li>
                    <li><strong>Non-Rate-Up Items:</strong> Non-Featured Items on a banner, general pool you "lose" to</li>
                    <br>
                    <li><strong>Hard Pity System:</strong> Guarantees a 5★/4★ item if item hasn't been pulled yet</li>
                    <li><strong>Hard Pity Cap:</strong> Exact pull number that guarantees an item</li>
                    <li><strong>Guarantee Rate-Up After:</strong> Guarantees a Rate-Up item after losing to Non-Rate-Up X amount of times</li>
                    <br>
                    <li><strong>Soft Pity System:</strong> Increases chances of getting the 5★/4★ item that hasn't been pulled yet</li>
                    <li><strong>Soft Pity Threshold:</strong> Exact pull number when the rate starts increasing</li>
                    <li><strong>Soft Pity Increment:</strong> How much the rate increases each pull past the threshold</li>
                    <br>
                    <li><strong>Sparking System:</strong>  Enables free pick-up of 5★ Rate-Up item after pulling a certain number of times (does not affect pity logic) </li>
                    <li><strong>Pull Requirement:</strong> Number of pulls to "spark" or get an Item</li>
                    <br>
                    <li><strong>Cost per Pull:</strong> Conversion of IRL money to pulls (based on Highest Top-Up)</li>
                    <br>
                    <li><strong>Other Notes: </strong> 3★ Base Rate, 5★/4★ Non-Rate-Up Items are disabled/uneditable.</li>
                </ul>
            </section>
        
            <!-- Dynamically injected content will appear here -->
        </div>

    </main>

    <script>

        //---------- Main Simulation Logic ----------//
        //---------- Main Simulation Logic ----------//
        //---------- Main Simulation Logic ----------//
        //---------- Main Simulation Logic ----------//
        //---------- Main Simulation Logic ----------//

        function getGachaSettings() {
            return {
                pool: {
                    "5★": Math.max(parseFloat(document.getElementById('fiveStarNonRateUpItems').value) || 1, 1),
                    "4★": Math.max(parseFloat(document.getElementById('fourStarNonRateUpItems').value) || 1, 1),
                    "3★": parseFloat(document.getElementById('threeStarRate').value) || 50
                },
                rates: {
                    "5★": parseFloat(document.getElementById('fiveStarBaseRate').value) || 0,
                    "4★": parseFloat(document.getElementById('fourStarBaseRate').value) || 0,
                    "3★": parseFloat(document.getElementById('threeStarRate').value) || 0
                }
            };
        }

        function runMonteCarloSimulation() {
            try {
                const settings = getGachaSettings();
                const pulls = parseInt(document.getElementById("simulationCount").value) || 100000;

                const fiveStarRateUpCount = parseInt(document.getElementById('fiveStarRateUpItems').value) || 1;
                const fourStarRateUpCount = parseInt(document.getElementById('fourStarRateUpItems')?.value) || 1;

                const generateItemLabels = (count) =>
                    Array.from({ length: count }, (_, i) => String.fromCharCode(65 + i)); // A-Z

                const fiveStarRateUpLabels = generateItemLabels(Math.min(fiveStarRateUpCount, 26));
                const fourStarRateUpLabels = generateItemLabels(Math.min(fourStarRateUpCount, 26));

                let results = {
                    "5★": {
                        total: 0,
                        NonRateUp: 0,
                        RateUp: 0,
                        pulls: [],
                        NonRateUpPulls: [],
                        RateUpPulls: [],
                        pullNumbers: [],
                        NonRateUpPullNumbers: [],
                        RateUpPullNumbers: [],
                        hardPityHits: { total: 0, NonRateUp: 0, RateUp: 0 },
                        softPityHits: [],
                        softPityHitCount: 0,
                        softPityPullNumbers: [],
                        RateUpItems: {},
                        RateUpSetStats: []
                    },
                    "4★": {
                        total: 0,
                        NonRateUp: 0,
                        RateUp: 0,
                        pulls: [],
                        NonRateUpPulls: [],
                        RateUpPulls: [],
                        pullNumbers: [],
                        NonRateUpPullNumbers: [],
                        RateUpPullNumbers: [],
                        hardPityHits: { total: 0, NonRateUp: 0, RateUp: 0 },
                        softPityHits: [],
                        softPityHitCount: 0,
                        softPityPullNumbers: [],
                        RateUpItems: {},
                        RateUpSetStats: []
                    },
                    "3★": 0
                };

                const initRateUpTracking = (labels) => {
                    const obj = {};
                    for (let label of labels) {
                        obj[label] = {
                            count: 0,
                            pullsSinceLast: 0,
                            pullsToNext: [],
                            totalPulls: 0
                        };
                    }
                    return obj;
                };

                results["5★"].RateUpItems = initRateUpTracking(fiveStarRateUpLabels);
                results["4★"].RateUpItems = initRateUpTracking(fourStarRateUpLabels);

                const RateUpRates = {
                    "5★": parseFloat(document.getElementById('fiveStarRateUpDistributionRate').value) || 0,
                    "4★": parseFloat(document.getElementById('fourStarRateUpDistributionRate')?.value) || 0
                };

                const useHardPity = document.getElementById("enableHardPity").checked;
                const useSoftPity = document.getElementById("enableSoftPity").checked;
                const hardPity5Value = parseInt(document.getElementById("fiveStarPity").value) || 90;
                const hardPity4Value = parseInt(document.getElementById("fourStarPity").value) || 10;
                const useGuaranteedRateUp5 = document.getElementById("enableFiveStarGuaranteed").checked;
                const guaranteeAfterNonRateUp5 = parseInt(document.getElementById("fiveStarGuaranteedAfter").value) || 1;
                const useGuaranteedRateUp4 = document.getElementById("enableFourStarGuaranteed")?.checked;
                const guaranteeAfterNonRateUp4 = parseInt(document.getElementById("fourStarGuaranteedAfter")?.value) || 1;

                const softPity = useSoftPity ? getSoftPityRates() : null;

                const sparkEnabled = document.getElementById("enableSparking").checked;
                const sparkThreshold = parseInt(document.getElementById("fiveStarSparkRequirement")?.value) || 0;
                let pullsSinceLastSpark = 0;
                // Initialize spark stats with keys used later in updateSimulationResults:
                let sparkStats = {
                    sparked: 0,
                    // nonSparked will be computed later
                    preSparkSuccess: 0,
                    preSparkFailure: 0,
                    preSparkVariety: { "0": 0, "1": 0, "2+": 0 }
                    // We'll add total and sparkAttempts later.
                };
                let sparkRateUpSet = new Set();

                // We'll track real pulls for pity in a separate variable.
                let pullCountSinceLast5 = 0;
                let internalPullCountSinceLast5 = 0;
                let pullCountSinceLast4 = 0;
                let pullsSinceLast5RateUp = 0,
                    pullsSinceLast5NonRateUp = 0;
                let pullsSinceLast4RateUp = 0,
                    pullsSinceLast4NonRateUp = 0;
                let NonRateUp5Streak = 0,
                    NonRateUp4Streak = 0;

                let fiveStarSet = new Set();
                let fourStarSet = new Set();
                let pullSinceLast5SetComplete = 0;
                let pullSinceLast4SetComplete = 0;

                for (let i = 0; i < pulls; i++) {
                    if (sparkEnabled) {
                        pullsSinceLastSpark++;
                    }

                    pullCountSinceLast5++;
                    internalPullCountSinceLast5++;
                    pullCountSinceLast4++;
                    pullsSinceLast5RateUp++;
                    pullsSinceLast5NonRateUp++;
                    pullsSinceLast4RateUp++;
                    pullsSinceLast4NonRateUp++;
                    pullSinceLast5SetComplete++;
                    pullSinceLast4SetComplete++;

                    for (let label of fiveStarRateUpLabels)
                        results["5★"].RateUpItems[label].pullsSinceLast++;
                    for (let label of fourStarRateUpLabels)
                        results["4★"].RateUpItems[label].pullsSinceLast++;

                    let fiveStarRate = settings.rates["5★"];
                    let fourStarRate = settings.rates["4★"];

                    if (useSoftPity) {
                        if (internalPullCountSinceLast5 >= softPity["5★"].threshold) {
                            fiveStarRate = Math.min(
                                100,
                                fiveStarRate +
                                    (internalPullCountSinceLast5 - softPity["5★"].threshold + 1) *
                                        softPity["5★"].rateIncrement
                            );
                        }
                        if (pullCountSinceLast4 >= softPity["4★"].threshold) {
                            fourStarRate = Math.min(
                                100 - fiveStarRate,
                                fourStarRate +
                                    (pullCountSinceLast4 - softPity["4★"].threshold + 1) *
                                        softPity["4★"].rateIncrement
                            );
                        }
                    }

                    let roll = Math.random() * 100;
                    let is5Star = false,
                        is4Star = false;
                    let hitHardPity5 = false,
                        hitHardPity4 = false;
                    let hitSoftPity5 = false,
                        hitSoftPity4 = false;

                    if (useHardPity && internalPullCountSinceLast5 >= hardPity5Value) {
                        is5Star = true;
                        hitHardPity5 = true;
                    } else if (roll < fiveStarRate) {
                        is5Star = true;
                        if (
                            useSoftPity &&
                            internalPullCountSinceLast5 >= softPity["5★"].threshold &&
                            (!useHardPity || internalPullCountSinceLast5 < hardPity5Value)
                        ) {
                            hitSoftPity5 = true;
                        }
                    } else if (useHardPity && pullCountSinceLast4 >= hardPity4Value) {
                        is4Star = true;
                        hitHardPity4 = true;
                    } else if (roll < fiveStarRate + fourStarRate) {
                        is4Star = true;
                        if (
                            useSoftPity &&
                            pullCountSinceLast4 >= softPity["4★"].threshold &&
                            (!useHardPity || pullCountSinceLast4 < hardPity4Value)
                        ) {
                            hitSoftPity4 = true;
                        }
                    }

                    if (is5Star) {
                        results["5★"].total++;
                        results["5★"].pulls.push(pullCountSinceLast5);
                        results["5★"].pullNumbers.push(i + 1);
                        if (hitSoftPity5) {
                            results["5★"].softPityHits.push(internalPullCountSinceLast5);
                            results["5★"].softPityPullNumbers.push(i + 1);
                            results["5★"].softPityHitCount++;
                        }

                        let isRateUp = Math.random() * 100 < RateUpRates["5★"];
                        if (useGuaranteedRateUp5 && NonRateUp5Streak >= guaranteeAfterNonRateUp5)
                            isRateUp = true;

                        if (isRateUp) {
                            results["5★"].RateUp++;
                            results["5★"].RateUpPulls.push(pullsSinceLast5RateUp);
                            results["5★"].RateUpPullNumbers.push(i + 1);
                            if (hitHardPity5) results["5★"].hardPityHits.RateUp++;

                            const item =
                                fiveStarRateUpLabels[
                                    Math.floor(Math.random() * fiveStarRateUpLabels.length)
                                ];
                            let track = results["5★"].RateUpItems[item];
                            track.count++;
                            track.pullsToNext.push(track.pullsSinceLast);
                            track.totalPulls += track.pullsSinceLast;
                            track.pullsSinceLast = 0;

                            sparkRateUpSet.add(item);
                            fiveStarSet.add(item);
                            if (fiveStarSet.size === fiveStarRateUpLabels.length) {
                                results["5★"].RateUpSetStats.push(pullSinceLast5SetComplete);
                                pullSinceLast5SetComplete = 0;
                                fiveStarSet.clear();
                            }

                            pullsSinceLast5RateUp = 0;
                            NonRateUp5Streak = 0;
                        } else {
                            results["5★"].NonRateUp++;
                            results["5★"].NonRateUpPulls.push(pullsSinceLast5NonRateUp);
                            results["5★"].NonRateUpPullNumbers.push(i + 1);
                            if (hitHardPity5) results["5★"].hardPityHits.NonRateUp++;
                            pullsSinceLast5NonRateUp = 0;
                            NonRateUp5Streak++;
                        }

                        if (hitHardPity5) results["5★"].hardPityHits.total++;
                        pullCountSinceLast5 = 0;
                        internalPullCountSinceLast5 = 0;
                    } else if (is4Star) {
                        results["4★"].total++;
                        results["4★"].pulls.push(pullCountSinceLast4);
                        results["4★"].pullNumbers.push(i + 1);
                        if (hitSoftPity4) {
                            results["4★"].softPityHits.push(pullCountSinceLast4);
                            results["4★"].softPityPullNumbers.push(i + 1);
                            results["4★"].softPityHitCount++;
                        }

                        let isRateUp = Math.random() * 100 < RateUpRates["4★"];
                        if (useGuaranteedRateUp4 && NonRateUp4Streak >= guaranteeAfterNonRateUp4)
                            isRateUp = true;

                        if (isRateUp) {
                            results["4★"].RateUp++;
                            results["4★"].RateUpPulls.push(pullsSinceLast4RateUp);
                            results["4★"].RateUpPullNumbers.push(i + 1);
                            if (hitHardPity4) results["4★"].hardPityHits.RateUp++;

                            const item =
                                fourStarRateUpLabels[
                                    Math.floor(Math.random() * fourStarRateUpLabels.length)
                                ];
                            let track = results["4★"].RateUpItems[item];
                            track.count++;
                            track.pullsToNext.push(track.pullsSinceLast);
                            track.totalPulls += track.pullsSinceLast;
                            track.pullsSinceLast = 0;

                            fourStarSet.add(item);
                            if (fourStarSet.size === fourStarRateUpLabels.length) {
                                results["4★"].RateUpSetStats.push(pullSinceLast4SetComplete);
                                pullSinceLast4SetComplete = 0;
                                fourStarSet.clear();
                            }

                            pullsSinceLast4RateUp = 0;
                            NonRateUp4Streak = 0;
                        } else {
                            results["4★"].NonRateUp++;
                            results["4★"].NonRateUpPulls.push(pullsSinceLast4NonRateUp);
                            results["4★"].NonRateUpPullNumbers.push(i + 1);
                            if (hitHardPity4) results["4★"].hardPityHits.NonRateUp++;
                            pullsSinceLast4NonRateUp = 0;
                            NonRateUp4Streak++;
                        }

                        if (hitHardPity4) results["4★"].hardPityHits.total++;
                        pullCountSinceLast4 = 0;
                    } else {
                        results["3★"]++;
                    }

                    // Spark logic
                    if (sparkEnabled && pullsSinceLastSpark >= sparkThreshold) {
                        sparkStats.sparked++;

                        const preSparkPulled = sparkRateUpSet.size;
                        if (preSparkPulled === 0) {
                            sparkStats.preSparkFailure++;
                        } else {
                            sparkStats.preSparkSuccess++;
                        }

                        if (preSparkPulled >= 2) {
                            sparkStats.preSparkVariety["2+"]++;
                        } else {
                            sparkStats.preSparkVariety[preSparkPulled.toString()]++;
                        }

                        const perItemSpark = 1 / fiveStarRateUpLabels.length;
                        for (let label of fiveStarRateUpLabels) {
                            const track = results["5★"].RateUpItems[label];
                            track.count += perItemSpark;
                            track.pullsToNext.push(pullsSinceLast5RateUp);
                            track.totalPulls += pullsSinceLast5RateUp;
                        }

                        results["5★"].total += 1;
                        results["5★"].RateUp += 1;
                        results["5★"].RateUpPulls.push(pullsSinceLast5RateUp);
                        results["5★"].RateUpPullNumbers.push(i + 1);
                        results["5★"].pulls.push(pullCountSinceLast5);
                        results["5★"].pullNumbers.push(i + 1);

                        pullCountSinceLast5 = 0;
                        pullsSinceLast5RateUp = 0;
                        pullsSinceLastSpark = 0;
                        sparkRateUpSet.clear();
                    }
                }

                results["5★"].RateUpItemCounts = {};
                results["5★"].pullsToNext = {};
                for (const [label, data] of Object.entries(results["5★"].RateUpItems)) {
                    results["5★"].RateUpItemCounts[label] = data.count;
                    results["5★"].pullsToNext[label] = data.pullsToNext;
                }
                results["5★"].pullsToFullSet = results["5★"].RateUpSetStats;

                results["4★"].RateUpItemCounts = {};
                results["4★"].pullsToNext = {};
                for (const [label, data] of Object.entries(results["4★"].RateUpItems)) {
                    results["4★"].RateUpItemCounts[label] = data.count;
                    results["4★"].pullsToNext[label] = data.pullsToNext;
                }
                results["4★"].pullsToFullSet = results["4★"].RateUpSetStats;

                sparkStats.nonSparked = results["5★"].total - sparkStats.sparked;
                sparkStats.sparkAttempts = sparkStats.preSparkSuccess + sparkStats.preSparkFailure;
                sparkStats.total = results["5★"].total;

                // Alias for UI compatibility
                sparkStats.successBeforeSpark = sparkStats.preSparkSuccess;
                sparkStats.failureBeforeSpark = sparkStats.preSparkFailure;

                updateSimulationResults(results, pulls, sparkStats);
            } catch (error) {
                if (
                    error instanceof RangeError &&
                    error.message.includes("Maximum call stack size exceeded")
                ) {
                    alert(
                        "Error: Simulation terminated due to exceeding call stack size. Try using fewer pulls."
                    );
                } else {
                    alert("An unexpected error occurred during the simulation: " + error.message);
                    console.error(error);
                }
            }
        }
    
        function updateSimulationResults(results, pulls, sparkStats) {
            const useHardPity = document.getElementById("enableHardPity").checked;
            const useSoftPity = document.getElementById("enableSoftPity").checked;

            // Helper functions
            const formatDecimal = (num, decimals) => num.toFixed(decimals);
            const formatPct = (num, total) => total ? `${formatDecimal((num / total) * 100, 2)}%` : "0%";

            const stats5 = calculateStats(results["5★"].pulls);
            const stats5NonRateUp = calculateStats(results["5★"].NonRateUpPulls);
            const stats5RateUp = calculateStats(results["5★"].RateUpPulls);
            const soft5Stats = calculateStats(results["5★"].softPityHits);

            const stats4 = calculateStats(results["4★"].pulls);
            const stats4NonRateUp = calculateStats(results["4★"].NonRateUpPulls);
            const stats4RateUp = calculateStats(results["4★"].RateUpPulls);
            const soft4Stats = calculateStats(results["4★"].softPityHits);

            const hard5 = results["5★"].hardPityHits;
            const hard4 = results["4★"].hardPityHits;

            const setStats5 = calculateStats(results["5★"].pullsToFullSet);

            const allNextCopyPulls = Object.values(results["5★"].pullsToNext).flat();
            const allNextCopyStats = calculateStats(allNextCopyPulls);
            const allNextCopyPulls4 = Object.values(results["4★"].pullsToNext).flat();
            const allNextCopyStats4 = calculateStats(allNextCopyPulls4);

            const percentileRanges5 = calculatePercentileRanges(results["5★"].pulls);
            const percentileRanges5NonRateUp = calculatePercentileRanges(results["5★"].NonRateUpPulls);
            const percentileRanges5RateUp = calculatePercentileRanges(results["5★"].RateUpPulls);

            const percentileRanges4 = calculatePercentileRanges(results["4★"].pulls);
            const percentileRanges4NonRateUp = calculatePercentileRanges(results["4★"].NonRateUpPulls);
            const percentileRanges4RateUp = calculatePercentileRanges(results["4★"].RateUpPulls);

            const costPerPull = parseFloat(document.getElementById("costPerPull").value) || 0;
            const formatCost = (pulls) => `$${(pulls * costPerPull).toFixed(2)}`;
            
            let resultHTML = `
                <h3>Simulation Results</h3>

                <!-- Overall Distribution -->
                <h4>Overall Distribution</h4>
                <hr />
                <div class="stats-section">
                    <div><canvas id="rarityDistributionChart" class="donutchart-canvas"></canvas></div>
                    <div class="stats-block">
                        <p><strong>Total Pulls:</strong> ${pulls}</p><br>

                        <p><strong>General Rarity Distribution:</strong></p>
                        <ul>
                            <li>5★: ${results["5★"].total} (${formatPct(results["5★"].total, pulls)})</li>
                            <li>4★: ${results["4★"].total} (${formatPct(results["4★"].total, pulls)})</li>
                            <li>3★: ${results["3★"]} (${formatPct(results["3★"], pulls)})</li>
                        </ul><br>

                        <p><strong>Non-Rate-Up / Rate-Up Rarity Distribution:</strong></p>
                        <ul>
                            <li>5★ Rate-Up: ${results["5★"].RateUp} (${formatPct(results["5★"].RateUp, pulls)})</li>
                            <li>5★ Non-Rate-Up: ${results["5★"].NonRateUp} (${formatPct(results["5★"].NonRateUp, pulls)})</li>
                            <li>4★ Rate-Up: ${results["4★"].RateUp} (${formatPct(results["4★"].RateUp, pulls)})</li>
                            <li>4★ NonRate-Up: ${results["4★"].NonRateUp} (${formatPct(results["4★"].NonRateUp, pulls)})</li>
                            <li>3★: ${results["3★"]} (${formatPct(results["3★"], pulls)})</li>
                        </ul>
                    </div>
                </div>

                <!-- 5★ Stats -->
                <h4>5★ Statistics</h4>
                <hr />
                <div class="stats-section">
                    <div><canvas id="fiveStarDistributionChart" class="donutchart-canvas"></canvas></div>
                    <div class="stats-block">
                        <p><strong>Total 5★:</strong> ${results["5★"].total} (${formatPct(results["5★"].total, pulls)} from ${pulls} pulls)</p><br>

                        <p><strong>5★ Type Distribution:</strong></p>
                        <ul>
                            <li>Rate-Up: ${results["5★"].RateUp} (${formatPct(results["5★"].RateUp, results["5★"].total)})</li>
                            <li>Non-Rate-Up: ${results["5★"].NonRateUp} (${formatPct(results["5★"].NonRateUp, results["5★"].total)})</li>
                        </ul><br>

                        <p><strong>5★ Avg / Min / Max Pulls:</strong></p>
                        <ul>
                            <li>Any: <span class="avg-highlight">Avg (${stats5.avg})</span>, Min (${stats5.min}), Max (${stats5.max})</li>
                            <li>Rate-Up: <span class="avg-highlight">Avg (${stats5RateUp.avg})</span>, Min (${stats5RateUp.min}), Max (${stats5RateUp.max})</li>
                            <li>Non-Rate-Up: <span class="avg-highlight">Avg (${stats5NonRateUp.avg})</span>, Min (${stats5NonRateUp.min}), Max (${stats5NonRateUp.max})</li> 
                        </ul><br>

                        <p><strong>5★ Avg / Min / Max Cost:</strong></p>
                        <ul>
                            <li>Any: <span class="avg-highlight">Avg (${formatCost(stats5.avg)})</span>, Min (${formatCost(stats5.min)}), Max (${formatCost(stats5.max)})</li>
                            <li>Rate-Up: <span class="avg-highlight">Avg (${formatCost(stats5RateUp.avg)})</span>, Min (${formatCost(stats5RateUp.min)}), Max (${formatCost(stats5RateUp.max)})</li>
                            <li>Non-Rate-Up: <span class="avg-highlight">Avg (${formatCost(stats5NonRateUp.avg)})</span>, Min (${formatCost(stats5NonRateUp.min)}), Max (${formatCost(stats5NonRateUp.max)})</li>
                        </ul>
                    </div>

                    <div class="full-width-wrapper"><canvas id="fiveStarPullDistributionChart" class="histogram-canvas"></canvas></div>
                    <div class="half-width-wrapper"><canvas id="fiveStarNonRateUpPullDistanceChart" class="histogram-canvas"></canvas></div>
                    <div class="half-width-wrapper"><canvas id="fiveStarRateUpPullDistanceChart" class="histogram-canvas"></canvas></div>

                    <div class="stats-block">
                        <p><strong>5★ Pull Range Distribution</strong></p>
                        <ul>
                            ${formatPercentileRange("Any", percentileRanges5["70"])}
                            ${formatPercentileRange("Rate-Up", percentileRanges5RateUp["70"])}
                            ${formatPercentileRange("Non-Rate-Up", percentileRanges5NonRateUp["70"])}
                        </ul>
                    </div>

                    <!-- 5★ RateUp Items -->
                    ${
                        Object.keys(results["5★"].RateUpItemCounts).length >= 2 ? `
                            <div class="stats-block">
                                <p><strong>5★ Rate-Up Item Tracking:</strong><br>
                                    ${(() => {
                                        const counts = results["5★"].RateUpItemCounts;
                                        const total = Object.values(counts).reduce((a, b) => a + b, 0);
                                        const formatted = Object.entries(counts).map(([item, count]) => {
                                            const percent = total > 0 ? ((count / total) * 100).toFixed(1) : "0.0";
                                            return `Item ${item}: ${count} (${percent}%)`;
                                        }).join(", ");
                                        return `Total: ${total}<br>${formatted}`;
                                    })()}
                                </p> <br>

                                <p><strong>Pulls to Get One Specific Rate-Up 5★ Item (Avg / Min / Max):</strong></p>
                                <ul>
                                    ${(() => {
                                        const allRateUpItemPulls = Object.values(results["5★"].pullsToNext).flat();
                                        const stat = calculateStats(allRateUpItemPulls);
                                        return `
                                            <li>Pulls: <span class="avg-highlight stat-num">Avg (${stat.avg}</span>), Min (<span class="stat-num">${stat.min}</span>), Max (<span class="stat-num">${stat.max}</span>)<br>
                                            Cost: <span class="avg-highlight stat-cost">Avg (${formatCost(stat.avg)}</span>), Min (<span class="stat-cost">${formatCost(stat.min)}</span>), Max (<span class="stat-cost">${formatCost(stat.max)}</span>)</li>
                                        `;
                                    })()}
                                </ul><br>

                                <p><strong>Pulls to Get One Copy of Each Rate-Up 5★ Item (Avg / Min / Max):</strong></p>
                                <p>
                                    Pulls: Avg (<span class="avg-highlight stat-num">${setStats5.avg}</span>), Min (<span class="stat-num">${setStats5.min}</span>), Max (<span class="stat-num">${setStats5.max}</span>)<br>
                                    Cost: Avg (<span class="avg-highlight stat-cost">${formatCost(setStats5.avg)}</span>), Min (<span class="stat-cost">${formatCost(setStats5.min)}</span>), Max (<span class="stat-cost">${formatCost(setStats5.max)}</span>)
                                </p>
                            </div>
                        ` : ""
                    }
                </div>

                <!-- 4★ Stats -->
                <h4>4★ Statistics</h4>
                <hr />
                <div class="stats-section">
                    <div><canvas id="fourStarDistributionChart" class="donutchart-canvas"></canvas></div>
                    <div class="stats-block">
                        <p><strong>Total 4★:</strong> ${results["4★"].total} (${formatPct(results["4★"].total, pulls)} from ${pulls} pulls)</p><br>

                        <p><strong>4★ Type Distribution:</strong></p>
                        <ul>
                            <li>Rate-Up: ${results["4★"].RateUp} (${formatPct(results["4★"].RateUp, results["4★"].total)})</li>
                            <li>Non-Rate-Up: ${results["4★"].NonRateUp} (${formatPct(results["4★"].NonRateUp, results["4★"].total)})</li>
                        </ul><br>

                        <p><strong>4★ Avg / Min / Max Pulls:</strong></p>
                        <ul>
                            <li>Any: <span class="avg-highlight">Avg (${stats4.avg})</span>, Min (${stats4.min}), Max (${stats4.max})</li>
                            <li>Rate-Up: <span class="avg-highlight">Avg (${stats4RateUp.avg})</span>, Min (${stats4RateUp.min}), Max (${stats4RateUp.max})</li>
                            <li>Non-Rate-Up: <span class="avg-highlight">Avg (${stats4NonRateUp.avg})</span>, Min (${stats4NonRateUp.min}), Max (${stats4NonRateUp.max})</li>
                        </ul><br>

                        <p><strong>4★ Avg / Min / Max Cost:</strong></p>
                        <ul>
                            <li>Any: <span class="avg-highlight">Avg (${formatCost(stats4.avg)})</span>, Min (${formatCost(stats4.min)}), Max (${formatCost(stats4.max)})</li>
                            <li>Rate-Up: <span class="avg-highlight">Avg (${formatCost(stats4RateUp.avg)})</span>, Min (${formatCost(stats4RateUp.min)}), Max (${formatCost(stats4RateUp.max)})</li>
                            <li>Non-Rate-Up: <span class="avg-highlight">Avg (${formatCost(stats4NonRateUp.avg)})</span>, Min (${formatCost(stats4NonRateUp.min)}), Max (${formatCost(stats4NonRateUp.max)})</li>
                        </ul>
                    </div>

                    <div class="full-width-wrapper"><canvas id="fourStarPullDistributionChart" class="histogram-canvas"></canvas></div>
                    <div class="half-width-wrapper"><canvas id="fourStarNonRateUpPullDistanceChart" class="histogram-canvas"></canvas></div>
                    <div class="half-width-wrapper"><canvas id="fourStarRateUpPullDistanceChart" class="histogram-canvas"></canvas></div>

                    <div class="stats-block">
                        <p><strong>4★ Pull Range Distribution</strong></p>
                        <ul>
                            ${formatPercentileRange("Any", percentileRanges4["70"])}
                            ${formatPercentileRange("Rate-Up", percentileRanges4RateUp["70"])}
                            ${formatPercentileRange("Non-Rate-Up", percentileRanges4NonRateUp["70"])}
                        </ul>
                    </div>

                    <!-- 4★ Rate-Up Items -->
                    ${
                        Object.keys(results["4★"].RateUpItemCounts).length >= 2 ? `
                            <div class="stats-block">
                                <p><strong>4★ Rate-Up Item Tracking:</strong><br>
                                    ${(() => {
                                        const counts = results["4★"].RateUpItemCounts;
                                        const total = Object.values(counts).reduce((a, b) => a + b, 0);
                                        const formatted = Object.entries(counts).map(([item, count]) => {
                                            const percent = total > 0 ? ((count / total) * 100).toFixed(1) : "0.0";
                                            return `Item ${item}: ${count} (${percent}%)`;
                                        }).join(", ");
                                        return `Total: ${total}<br>${formatted}`;
                                    })()}
                                </p> <br>

                                <p><strong>Pulls to Get One Specific Rate-Up 4★ Item (Avg / Min / Max):</strong></p>
                                <ul>
                                    ${(() => {
                                        const allRateUpItemPulls = Object.values(results["4★"].pullsToNext).flat();
                                        const stat = calculateStats(allRateUpItemPulls);
                                        return `
                                            <li>Pulls: <span class="avg-highlight stat-num">Avg (${stat.avg}</span>), Min (<span class="stat-num">${stat.min}</span>), Max (<span class="stat-num">${stat.max}</span>)<br>
                                            Cost: <span class="avg-highlight stat-cost">Avg (${formatCost(stat.avg)}</span>), Min (<span class="stat-cost">${formatCost(stat.min)}</span>), Max (<span class="stat-cost">${formatCost(stat.max)}</span>)</li>
                                        `;
                                    })()}
                                </ul><br>

                                <p><strong>Pulls to Get One Copy of Each Rate-Up 4★ Item (Avg / Min / Max):</strong></p>
                                <p>
                                    ${(() => {
                                        const setStats4 = calculateStats(results["4★"].pullsToFullSet || []);
                                        return `Pulls: <span class="avg-highlight stat-num">Avg (${setStats4.avg}</span>), Min (<span class="stat-num">${setStats4.min}</span>), Max (<span class="stat-num">${setStats4.max}</span>)<br>
                                        Cost: <span class="avg-highlight stat-cost">Avg (${formatCost(setStats4.avg)}</span>), Min (<span class="stat-cost">${formatCost(setStats4.min)}</span>), Max (<span class="stat-cost">${formatCost(setStats4.max)}</span>)`;
                                    })()}
                                </p>
                            </div>
                        ` : ""
                    }
                </div>
            `;

            if (useHardPity) {
                const nonHard5 = results["5★"].total - hard5.total;
                const nonHard4 = results["4★"].total - hard4.total;

                resultHTML += `
                    <h4>Hard Pity Statistics</h4>
                    <hr />
                    <div class="stats-section">
                        <div><canvas id="fiveStarHardPityChart" class="donutchart-canvas"></canvas></div>
                        <div><canvas id="fourStarHardPityChart" class="donutchart-canvas"></canvas></div>
                        <div class="stats-block">
                            <p><strong>5★ Hard Pity Distribution:</strong></p>
                            <ul>
                                <li>Hard Pity: ${hard5.total} (${formatPct(hard5.total, results["5★"].total)})</li>
                                <li>Non-Hard Pity: ${nonHard5} (${formatPct(nonHard5, results["5★"].total)})</li>
                            </ul><br>

                            <p><strong>4★ Hard Pity Distribution:</strong></p>
                            <ul>
                                <li>Hard Pity: ${hard4.total} (${formatPct(hard4.total, results["4★"].total)})</li>
                                <li>Non-Hard Pity: ${nonHard4} (${formatPct(nonHard4, results["4★"].total)})</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            if (useSoftPity) {
                const nonSoft5 = results["5★"].total - results["5★"].softPityHitCount;
                const nonSoft4 = results["4★"].total - results["4★"].softPityHitCount;

                resultHTML += `
                    <h4>Soft Pity Statistics</h4>
                    <hr />
                    <div class="stats-section">
                        <div><canvas id="fiveStarSoftPityChart" class="donutchart-canvas"></canvas></div>
                        <div><canvas id="fourStarSoftPityChart" class="donutchart-canvas"></canvas></div>

                        <div class="stats-block">
                            <!-- 5★ Soft Pity Distribution -->
                            <p><strong>5★ Soft Pity Distribution:</strong></p>
                            <ul>
                                <li>Soft Pity: ${results["5★"].softPityHitCount} (${formatPct(results["5★"].softPityHitCount, results["5★"].total)})</li>
                                <li>Non-Soft Pity: ${nonSoft5} (${formatPct(nonSoft5, results["5★"].total)})</li>
                            </ul><br>

                            <!-- 4★ Soft Pity Distribution -->
                            <p><strong>4★ Soft Pity Distribution:</strong></p>
                            <ul>
                                <li>Soft Pity: ${results["4★"].softPityHitCount} (${formatPct(results["4★"].softPityHitCount, results["4★"].total)})</li>
                                <li>Non-Soft Pity: ${nonSoft4} (${formatPct(nonSoft4, results["4★"].total)})</li>
                            </ul>
                        </div>

                        <div class="half-width-wrapper"><canvas id="fiveStarSoftPityDistributionChart" class="histogram-canvas"></canvas></div>
                        <div class="half-width-wrapper"><canvas id="fourStarSoftPityDistributionChart" class="histogram-canvas"></canvas></div>

                        <div class="stats-block">
                            <p><strong>Soft Pity Pull Range (5★):</strong></p>
                            <ul>
                                <li><span class="avg-highlight">Avg (${soft5Stats.avg}</span>), Min (${soft5Stats.min}), Max (${soft5Stats.max})</li>
                            </ul><br>

                            <p><strong>Soft Pity Pull Range (4★):</strong></p>
                            <ul>
                                <li><span class="avg-highlight">Avg (${soft4Stats.avg}</span>), Min (${soft4Stats.min}), Max (${soft4Stats.max})</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            if (document.getElementById("enableSparking").checked) {
                resultHTML += `
                    <!-- Sparking System Results -->
                    <h4>Sparking System</h4>
                    <hr />
                    <div class="stats-section">
                        <div><canvas id="sparkedVsNonSparkedChart" class="donutchart-canvas"></canvas></div>
                        <div><canvas id="sparkSuccessChart" class="donutchart-canvas"></canvas></div>
                        <div class="stats-block">
                            <p><strong>5★ Rate-Up Items - Sparked vs Non-Sparked:</strong></p>
                            <ul>
                                <li>Sparked: ${sparkStats.sparked} (${formatPct(sparkStats.sparked, sparkStats.total)})</li>
                                <li>Non-Sparked: ${sparkStats.nonSparked} (${formatPct(sparkStats.nonSparked, sparkStats.total)})</li>
                            </ul><br>

                            <p><strong>Success vs Failure Before Spark:</strong></p>
                            <ul>
                                <li>Success Before Spark: ${sparkStats.preSparkSuccess} (${formatPct(sparkStats.preSparkSuccess, sparkStats.sparkAttempts)})</li>
                                <li>Failure Before Spark: ${sparkStats.preSparkFailure} (${formatPct(sparkStats.preSparkFailure, sparkStats.sparkAttempts)})</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            resultHTML += `
                <h4>Survey Form</h4>
                <hr />
                <div class="stats-section">
                    <div class="stats-block">
                        <p>
                            <i>
                                Don't forget to answer the survey form! 
                                <a href="https://forms.gle/xnt2UUgmYqDMzo7T8" target="_blank" rel="noopener">
                                    https://forms.gle/xnt2UUgmYqDMzo7T8
                                </a>
                            </i>
                        </p>
                    </div>
                </div>
            `;

            resultHTML += `</div>`;

            document.getElementById("resultsPanel").innerHTML = resultHTML;
            resultsPanel.innerHTML = resultHTML;

            // Render Charts
            renderDoughnutChart("rarityDistributionChart", ["5★ Rate-Up", "5★ Non-Rate-Up", "4★ Rate-Up", "4★ Non-Rate-Up", "3★"], [results["5★"].RateUp, results["5★"].NonRateUp, results["4★"].RateUp, results["4★"].NonRateUp, results["3★"]], ["#FFD700", "#BFB773", "#B366FF", "#9E84B7", "#3DA5A5"], "Total Item Distribution");
            renderDoughnutChart("fiveStarDistributionChart", ["5★ Rate-Up", "5★ Non-Rate-Up"], [results["5★"].RateUp, results["5★"].NonRateUp], ["#FFD700", "#BFB773"], "5★: Non-ate-Up vs Rate-Up");
            renderDoughnutChart("fourStarDistributionChart", ["4★ Rate-Up", "4★ Non-Rate-Up"], [results["4★"].RateUp, results["4★"].NonRateUp], ["#B366FF", "#9E84B7"], "4★: Non-Rate-Up vs Rate-Up");

            renderHistogramChart(results["5★"].pulls, "5★", "fiveStarPullDistributionChart", "rgba(255, 215, 100, 0.6)", "5★ Pull Distribution", "Pull Number", "5★ Frequency");
            renderHistogramChart(results["5★"].NonRateUpPulls, "5★", "fiveStarNonRateUpPullDistanceChart", "rgba(191, 183, 115, 0.6)", "5★ Pulls Distance (Non-Rate-Up)", "Pulls Since Last Non-Rate-Up 5★", "Count");
            renderHistogramChart(results["5★"].RateUpPulls, "5★", "fiveStarRateUpPullDistanceChart", "rgba(255, 215, 0, 0.6)", "5★ Pulls Distance (Rate-Up)", "Pulls Since Last Rate-Up 5★", "Count");

            renderHistogramChart(results["4★"].pulls, "4★", "fourStarPullDistributionChart", "rgba(179, 102, 230, 0.6)", "4★ Pull Distribution", "Pull Number", "4★ Frequency");
            renderHistogramChart(results["4★"].NonRateUpPulls, "4★", "fourStarNonRateUpPullDistanceChart", "rgba(158, 132, 183, 0.6)", "4★ Pulls Distance (Non-Rate-Up)", "Pulls Since Last Non-Rate-Up 4★", "Count");
            renderHistogramChart(results["4★"].RateUpPulls, "4★", "fourStarRateUpPullDistanceChart", "rgba(179, 102, 255, 0.6)", "4★ Pulls Distance (Rate-Up)", "Pulls Since Last Rate-Up 4★", "Count");


            if (useHardPity) {
                renderDoughnutChart("fiveStarHardPityChart", ["Hard Pity", "Non-Hard Pity"], [hard5.total, results["5★"].total - hard5.total], ["#E6A400", "#FFDD66"], "5★ Hard vs Non-Hard Pity");
                renderDoughnutChart("fourStarHardPityChart", ["Hard Pity", "Non-Hard Pity"], [hard4.total, results["4★"].total - hard4.total], ["#8E44AD", "#C39BD3"], "4★ Hard vs Non-Hard Pity");
            }
            if (useSoftPity) {
                renderDoughnutChart("fiveStarSoftPityChart", ["Soft Pity", "Non-Soft Pity"], [results["5★"].softPityHitCount, results["5★"].total - results["5★"].softPityHitCount], ["#E6A400", "#FFDD66"], "5★ Soft vs Non-Soft Pity");
                renderDoughnutChart("fourStarSoftPityChart", ["Soft Pity", "Non-Soft Pity"], [results["4★"].softPityHitCount, results["4★"].total - results["4★"].softPityHitCount], ["#8E44AD", "#C39BD3"], "4★ Soft vs Non-Soft Pity");

                renderHistogramChart(results["5★"].softPityHits, "5★", "fiveStarSoftPityDistributionChart", "rgba(230, 164, 0, 0.6)", "5★ Soft Pity Pull Distribution", "Soft Pity Pull Number", "Soft Pity Hits");
                renderHistogramChart(results["4★"].softPityHits, "4★", "fourStarSoftPityDistributionChart", "rgba(142, 68, 173, 0.6)", "4★ Soft Pity Pull Distribution", "Soft Pity Pull Number", "Soft Pity Hits");            }
            if (document.getElementById("enableSparking").checked) {
                renderDoughnutChart(
                    "sparkedVsNonSparkedChart",
                    ["Sparked", "Non-Sparked"],
                    [sparkStats.sparked, sparkStats.nonSparked],
                    ["#FFA07A", "#20B2AA"],
                    "Sparked vs Non-Sparked (5★ Rate-Up)"
                );

                renderDoughnutChart(
                    "sparkSuccessChart",
                    ["Success Before Spark", "Failure (Needed Spark)"],
                    [sparkStats.successBeforeSpark, sparkStats.failureBeforeSpark],
                    ["#90EE90", "#FF6B6B"],
                    "Success vs Failure Before Spark (Any 5★ Rate-Up)"
                );
            }
        }

        function calculatePercentileRanges(pulls, percentiles = [50, 70, 80, 90, 95]) {
            if (!pulls || pulls.length === 0) return {};

            const sorted = [...pulls].sort((a, b) => a - b);
            const result = {};

            percentiles.forEach(pct => {
                const lowerIndex = Math.floor((100 - pct) / 2 / 100 * sorted.length);
                const upperIndex = Math.ceil((1 - (100 - pct) / 2 / 100) * sorted.length) - 1;
                result[pct] = {
                    from: sorted[lowerIndex],
                    to: sorted[upperIndex]
                };
            });

            return result;
        }

        function formatPercentileRange(label, range) {
            if (!range) {
                return `<li>${label}: Not enough data</li>`;
            }
            return `<li>${label}: 70% of pulls happened between <strong> pulls ${range.from} and ${range.to} </strong></li>`;
        }

        function calculateStats(arr) {
            if (arr.length === 0) return { min: 0, avg: 0, max: 0 };
            let min = Math.min(...arr);
            let max = Math.max(...arr);
            let avg = arr.reduce((sum, val) => sum + val, 0) / arr.length;
            return { min, avg: formatDecimal(avg, 2), max };
        }

        function calculateAverage(itemCounts) {
            const totalPulls = Object.values(itemCounts).reduce((sum, count) => sum + count, 0);
            const numItems = Object.keys(itemCounts).length;
            return totalPulls / numItems;
        }

        function calculateMin(itemCounts) {
            return Math.min(...Object.values(itemCounts));
        }

        function calculateMax(itemCounts) {
            return Math.max(...Object.values(itemCounts));
        }

        function formatDecimal(value, minDecimals = 0) {
            let formattedValue = value.toFixed(3).replace(/\.?0+$/, '');
            if (minDecimals > 0 && !formattedValue.includes('.')) {
                formattedValue += '.' + '0'.repeat(minDecimals);
            }
            return formattedValue;
        }

        function renderDoughnutChart(canvasId, labels, data, colors, chartTitle) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '50%', // Adjust the thickness of the doughnut (50% is a good start)
                    plugins: {
                        title: {
                            display: true,
                            text: chartTitle, // Title for the chart
                            color: '#ffffff', // Title color
                            font: {
                                size: 18, // Font size for the title
                                weight: 'bold', // Font weight for the title
                            },
                            padding: {
                                bottom: 20, // Add some padding below the title
                            },
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#ffffff',
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (tooltipItem) => {
                                    const total = data.reduce((a, b) => a + b, 0);
                                    const value = tooltipItem.raw;
                                    const percentage = ((value / total) * 100).toFixed(2);
                                    return `${tooltipItem.label}: ${value} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            formatter: (value, ctx) => {
                                let total = ctx.chart._metasets[0].total || ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value / total * 100).toFixed(1) + '%';
                                return percentage;
                            },
                            anchor: 'center',
                            align: 'center',
                            offset: 8,
                            clamp: true,
                            display: (context) => {
                                const value = context.dataset.data[context.dataIndex];
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = (value / total * 100).toFixed(2);
                                return parseFloat(percentage) > 5; // Only display labels for slices larger than 5%
                            },
                            padding: 10
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderHistogramChart(data, label, canvasId, color, titleText, xLabel = "Pull Number", yLabel = "Frequency") {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // Optional: destroy any existing chart instance on this canvas
            if (ctx.chart) {
                ctx.chart.destroy();
            }

            const bins = {};
            data.forEach(value => {
                bins[value] = (bins[value] || 0) + 1;
            });

            const labels = Object.keys(bins).map(n => parseInt(n)).sort((a, b) => a - b);
            const counts = labels.map(label => bins[label]);

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label + ' Pulls',
                        data: counts,
                        backgroundColor: color,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: titleText,
                            color: '#ffffff',
                            font: {
                                size: 16,
                                weight: 'bold',
                            },
                            padding: {
                                top: 10,
                                bottom: 10,
                            }
                        },
                        legend: {
                            display: false
                        },
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xLabel,
                                color: '#ffffff'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yLabel,
                                color: '#ffffff'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });

            ctx.chart = chart;
        }

        //---------- Formatting Functions ----------//
        //---------- Formatting Functions ----------//
        //---------- Formatting Functions ----------//

        function formatDecimalInput(id) {
            const inputField = document.getElementById(id);
            let value = parseFloat(inputField.value) || 0;
            inputField.value = formatDecimal(value, 2);
        }

        function validateDecimalInput(id) {
            const inputField = document.getElementById(id);
            let value = inputField.value;

            // Remove any non-numeric characters except the decimal point
            value = value.replace(/[^0-9.]/g, "");

            // Allow only one decimal point
            if (value.split('.').length > 2) {
                value = value.substring(0, value.lastIndexOf('.')) + value.substring(value.lastIndexOf('.'), value.length).replace('.', '');
            }

            // Limit to 3 decimal places
            let decimalIndex = value.indexOf('.');
            if (decimalIndex !== -1) {
                value = value.substring(0, decimalIndex + 4); // Allow 3 decimal places (index 0 + decimal point + 3 digits)
            }

            // If the value is less than 0, default to 1
            if (parseFloat(value) < 0) {
                value = "1";
            }

            // If the value is greater than 100, default to 100
            if (parseFloat(value) > 100) {
                value = "100";
            }

            // Set the validated value
            inputField.value = value;
        }

        function sanitizeIntegerInput(input) {
            // Allow digits only during typing
            input.value = input.value.replace(/[^0-9]/g, "");
        }

        function validateIntegerInput(input, max = null) {
            let value = input.value.replace(/[^0-9]/g, "").replace(/^0+/, "");

            // Fallback to 1 if empty or less than 1
            if (value === "" || parseInt(value) < 1) {
                value = "1";
            }

            // Enforce max if provided
            if (max !== null && parseInt(value) > max) {
                value = String(max);
            }

            input.value = value;
        }

        function updateThreeStarRate() {
            const fiveStarRate = parseFloat(document.getElementById('fiveStarBaseRate').value) || 0;
            const fourStarRate = parseFloat(document.getElementById('fourStarBaseRate').value) || 0;
            const threeStarRate = Math.max(0, 100 - (fiveStarRate + fourStarRate));
            document.getElementById('threeStarRate').value = formatDecimal(threeStarRate, 2);
            validateRates();  // Revalidate all rates
        }

        function updateRateUpRates() {
            const fiveStarRate = parseFloat(document.getElementById('fiveStarBaseRate').value) || 0;
            const fourStarRate = parseFloat(document.getElementById('fourStarBaseRate').value) || 0;

            const valid = (fiveStarRate <= 100 && fourStarRate <= 100);
            document.getElementById('RunSimulationBtn').disabled = !valid;

            if (valid) {
                document.getElementById('rateUpValidationMessage').innerHTML = "<span style='color: green;'>✔</span>";
            } else {
                document.getElementById('rateUpValidationMessage').innerHTML = "<span style='color: red;'>Error: Each rate must be ≤ 100%</span>";
            }
        }

        function validateRates() {
            const fiveStarRate = parseFloat(document.getElementById('fiveStarBaseRate').value) || 0;
            const fourStarRate = parseFloat(document.getElementById('fourStarBaseRate').value) || 0;
            const threeStarRate = parseFloat(document.getElementById('threeStarRate').value) || 0;
            const totalRate = fiveStarRate + fourStarRate + threeStarRate;

            if (totalRate > 100) {
                document.getElementById('validationMessage').innerHTML = "<span style='color: red;'>Error: Total rates cannot exceed 100%.</span>";
                document.getElementById('RunSimulationBtn').disabled = true;
            } else if (Math.abs(totalRate - 100) < 0.0001) {
                document.getElementById('validationMessage').innerHTML = "";
                document.getElementById('RunSimulationBtn').disabled = false;
            } else {
                document.getElementById('validationMessage').innerHTML = "<span style='color: red;'>Error: Total rates must be 100%.</span>";
                document.getElementById('RunSimulationBtn').disabled = true;
            }
        }

        function validateItemCount(id) {
            const value = parseFloat(document.getElementById(id).value) || 1;
            document.getElementById(id).value = Math.max(value, 1);
        }

        function toggleHardPitySettings() {
            const hardPityEnabled = document.getElementById("enableHardPity").checked;
            const hardPitySettings = document.getElementById("hardPitySettings");
            
            // Toggle visibility of the Hard Pity settings section
            hardPitySettings.style.display = hardPityEnabled ? "block" : "none";
            
            // If Hard Pity is disabled, reset Guarantee RateUp settings
            if (!hardPityEnabled) {
                document.getElementById("enableFiveStarGuaranteed").checked = false;
                document.getElementById("enableFourStarGuaranteed").checked = false;
                
                // Hide the inputs and labels for Guarantee RateUp settings
                document.getElementById("fiveStarGuaranteedAfter").style.display = "none";
                document.getElementById("fiveGuaranteedLabel").style.display = "none";
                document.getElementById("fourStarGuaranteedAfter").style.display = "none";
                document.getElementById("fourGuaranteedLabel").style.display = "none";
            }
            // If Hard Pity is enabled, you could optionally set up behaviors for the Guarantee options
            else {
                // Uncomment and customize if you want to enable guarantee settings on Hard Pity enable
                // document.getElementById("enableFiveStarGuaranteed").disabled = false;
                // document.getElementById("enableFourStarGuaranteed").disabled = false;
            }
        }

        function toggleSoftPitySettings() {
            const softPitySettings = document.getElementById("softPitySettings");
            const isChecked = document.getElementById("enableSoftPity").checked;
            softPitySettings.style.display = isChecked ? "block" : "none";
        }
        
        function toggleSparkingSettings() {
            const checkbox = document.getElementById("enableSparking");
            const settings = document.getElementById("sparkingSettings");
            settings.style.display = checkbox.checked ? "block" : "none";
        }

        function initializeForm() {
            const softPitySettings = document.getElementById("softPitySettings");
            softPitySettings.style.display = "none";  // Soft Pity is disabled by default
            const hardPitySettings = document.getElementById("hardPitySettings");
            hardPitySettings.style.display = "none";  // Hard Pity is disabled by default
        }

        function getSoftPityRates() {
            const softPityFiveStarRate = parseFloat(document.getElementById("softPityFiveStarRate").value) || 0;
            const softPityFourStarRate = parseFloat(document.getElementById("softPityFourStarRate").value) || 0;
            const softPityFiveStarThreshold = parseInt(document.getElementById("softPityFiveStarThreshold").value) || 0;
            const softPityFourStarThreshold = parseInt(document.getElementById("softPityFourStarThreshold").value) || 0;

            return {
                "5★": {
                    rateIncrement: softPityFiveStarRate,
                    threshold: softPityFiveStarThreshold
                },
                "4★": {
                    rateIncrement: softPityFourStarRate,
                    threshold: softPityFourStarThreshold
                }
            };
        }

        function toggleGuaranteedInput(starTier) {
            const input = document.getElementById(`${starTier}StarGuaranteedAfter`);
            const label = document.getElementById(`${starTier}GuaranteedLabel`);
            const checkbox = document.getElementById(`enable${capitalize(starTier)}StarGuaranteed`);

            if (checkbox.checked) {
                input.style.display = 'inline-block';
                label.style.display = 'inline-block';
            } else {
                input.style.display = 'none';
                label.style.display = 'none';
            }
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
    </script>

</body>
</html>
